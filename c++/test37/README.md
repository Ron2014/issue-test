# 一致性哈希

参考 [一致性哈希算法的原理与实现](https://kefeng.wang/2018/08/10/consistent-hashing/#1-2-%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C-Consistent-Hashing)

写一个 C++ 版本

用于解决一个问题：在分布式系统中，对于同一来源的请求，总是唯一的转发至指定的服务中处理。

目的：在水平扩容或者缩容的时候，数据迁移足够少。

即

如果当前有 A B C 三台服务器，当我增加 1 台 D 时，为了将用户负载平均分配出去，则会出现分流

我们期望用户的分流不会出现

A->B

B->C

C->D

的情况（取模的方式就是如此的结果），这种数据迁移量很大，而且服务变多之后变得很难控制。

希望做到，增加时呈现

A -> D

B -> D

C -> D

这种方向的分流，使得数据迁移在可控制的范围内。

## 测试用例

node 代表服务，object 代表发送请求的用户ID。

输出信息如下

```bash
------ init for 16384 times
====== origin info1 : 65537 changed
 -> 192.168.1.101: 10571
 -> 192.168.1.102: 10844
 -> 192.168.1.103: 10869
 -> 192.168.1.104: 10832
 -> 192.168.1.105: 11429
 -> 192.168.1.106: 10992
IP=192.168.1.101: RATE=16.1298%
IP=192.168.1.102: RATE=16.5464%
IP=192.168.1.103: RATE=16.5845%
IP=192.168.1.104: RATE=16.5281%
IP=192.168.1.105: RATE=17.439%
IP=192.168.1.106: RATE=16.7722%
====== origin info2 : 0 changed
IP=192.168.1.101: RATE=16.1298%
IP=192.168.1.102: RATE=16.5464%
IP=192.168.1.103: RATE=16.5845%
IP=192.168.1.104: RATE=16.5281%
IP=192.168.1.105: RATE=17.439%
IP=192.168.1.106: RATE=16.7722%
====== remove 192.168.1.103 : 10869 changed
192.168.1.103 -> 192.168.1.101: 2435
192.168.1.103 -> 192.168.1.102: 1997
192.168.1.103 -> 192.168.1.104: 2167
192.168.1.103 -> 192.168.1.105: 2202
192.168.1.103 -> 192.168.1.106: 2068
IP=192.168.1.101: RATE=19.8453%
IP=192.168.1.102: RATE=19.5935%
IP=192.168.1.104: RATE=19.8346%
IP=192.168.1.105: RATE=20.7989%
IP=192.168.1.106: RATE=19.9277%
====== add 192.168.1.103 : 10869 changed
192.168.1.101 -> 192.168.1.103: 2435
192.168.1.102 -> 192.168.1.103: 1997
192.168.1.104 -> 192.168.1.103: 2167
192.168.1.105 -> 192.168.1.103: 2202
192.168.1.106 -> 192.168.1.103: 2068
IP=192.168.1.101: RATE=16.1298%
IP=192.168.1.102: RATE=16.5464%
IP=192.168.1.103: RATE=16.5845%
IP=192.168.1.104: RATE=16.5281%
IP=192.168.1.105: RATE=17.439%
IP=192.168.1.106: RATE=16.7722%
====== add 192.168.1.107 : 9909 changed
192.168.1.101 -> 192.168.1.107: 1526
192.168.1.102 -> 192.168.1.107: 1619
192.168.1.103 -> 192.168.1.107: 1799
192.168.1.104 -> 192.168.1.107: 1482
192.168.1.105 -> 192.168.1.107: 1627
192.168.1.106 -> 192.168.1.107: 1856
IP=192.168.1.101: RATE=13.8014%
IP=192.168.1.102: RATE=14.076%
IP=192.168.1.103: RATE=13.8395%
IP=192.168.1.104: RATE=14.2668%
IP=192.168.1.105: RATE=14.9564%
IP=192.168.1.106: RATE=13.9402%
IP=192.168.1.107: RATE=15.1197%
```

加了 sleep 方便用来查看内存使用情况

```bash
ps -ef | grep \.\/main | grep -v grep | awk '{print $2}' | xargs -I args sh -c 'cat /proc/args/status'
```

```bash
Name:   main
Umask:  0022
State:  S (sleeping)
Tgid:   2129
Ngid:   0
Pid:    2129
PPid:   1999
TracerPid:      0
Uid:    0       0       0       0
Gid:    0       0       0       0
FDSize: 256
Groups: 0
VmPeak:    23940 kB
VmSize:    23940 kB
VmLck:         0 kB
VmPin:         0 kB
VmHWM:     12420 kB
VmRSS:     12420 kB
RssAnon:           11276 kB
RssFile:            1144 kB
RssShmem:              0 kB
VmData:    11496 kB
VmStk:       132 kB
VmExe:        48 kB
VmLib:      3988 kB
VmPTE:        68 kB
VmSwap:        0 kB
Threads:        1
SigQ:   1/14990
SigPnd: 0000000000000000
ShdPnd: 0000000000000000
SigBlk: 0000000000000000
SigIgn: 0000000000000000
SigCgt: 0000000000000000
CapInh: 0000000000000000
CapPrm: 0000001fffffffff
CapEff: 0000001fffffffff
CapBnd: 0000001fffffffff
CapAmb: 0000000000000000
NoNewPrivs:     0
Seccomp:        0
Speculation_Store_Bypass:       thread vulnerable
Cpus_allowed:   ffffffff,ffffffff,ffffffff,ffffffff
Cpus_allowed_list:      0-127
Mems_allowed:   00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000001
Mems_allowed_list:      0
voluntary_ctxt_switches:        2
nonvoluntary_ctxt_switches:     8
```

## 编译

使用了一些 C++ 特性，编译的时候请指定版本号

```bash
g++ -o main main.cc ConsistentHashing.cc --std=c++11
```